{"version":3,"kind":"Notebook","sha256":"0847a18f67f1e62c33cbdc2806db5ff6b6c2c7aa744a1476d84ff672f9d28eb8","slug":"notebooks.diagnostics.cupid-output.regional-ocean-obc","location":"/notebooks/diagnostics/cupid_output/Regional_Ocean_OBC.ipynb","dependencies":[],"frontmatter":{"title":"Regional Ocean: Checking Open Boundary Conditions","content_includes_title":true,"kernelspec":{"name":"cupid-analysis","display_name":"cupid-analysis","language":"python"},"github":"https://github.com/CROCODILE-CESM/CrocoGallery","numbering":{"title":{"offset":3}},"source_url":"https://github.com/CROCODILE-CESM/CrocoGallery/blob/main/gallery/notebooks/diagnostics/cupid_output/Regional_Ocean_OBC.ipynb","edit_url":"https://github.com/CROCODILE-CESM/CrocoGallery/edit/main/gallery/notebooks/diagnostics/cupid_output/Regional_Ocean_OBC.ipynb","exports":[{"format":"ipynb","filename":"Regional_Ocean_OBC.ipynb","url":"/CrocoGallery/latest/build/Regional_Ocean_OBC-b19565ae1e0266bdb539d0d5fff46600.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","data":{"tags":["papermill-error-cell-tag"]},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"span","style":{"color":"red","fontFamily":"Helvetica Neue, Helvetica, Arial, sans-serif","fontSize":"2em"},"children":[{"type":"text","value":"An Exception was encountered at ‘ ","key":"clBGhwFMsa"},{"type":"crossReference","children":[{"type":"text","value":"In [7]","key":"B8QwKjOyFv"}],"identifier":"papermill-error-cell","label":"papermill-error-cell","kind":"span","template":"Span","resolved":true,"html_id":"papermill-error-cell","key":"G9PrO9hjmO"},{"type":"text","value":" ’.","key":"afvAmUzciO"}],"key":"UEavho8tdt"}],"key":"nAepRQfupQ"}],"visibility":"show","key":"DG0v2YHReX"},{"type":"block","kind":"notebook-content","data":{"papermill":{"duration":0.003857,"end_time":"2025-10-13T13:54:28.370352","exception":false,"start_time":"2025-10-13T13:54:28.366495","status":"completed"},"tags":[]},"children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Regional Ocean: Checking Open Boundary Conditions","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kmSWsuj9fF"}],"identifier":"regional-ocean-checking-open-boundary-conditions","label":"Regional Ocean: Checking Open Boundary Conditions","html_id":"regional-ocean-checking-open-boundary-conditions","implicit":true,"key":"ZwvzfUNV6U"}],"visibility":"show","key":"vfCCBWCLLm"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-10-13T13:54:28.377342Z","iopub.status.busy":"2025-10-13T13:54:28.377156Z","iopub.status.idle":"2025-10-13T13:54:31.521312Z","shell.execute_reply":"2025-10-13T13:54:31.520953Z"},"papermill":{"duration":3.149549,"end_time":"2025-10-13T13:54:31.522243","exception":false,"start_time":"2025-10-13T13:54:28.372694","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import xarray as xr\nimport numpy as np\nimport os\nfrom pathlib import Path\nimport glob\nimport regional_utils as utils","visibility":"hide","key":"bsgoNKNhrB"},{"type":"outputs","id":"_3wW_Bj12hpuTevpMEmWZ","children":[],"visibility":"show","key":"gCT2rEGyKR"}],"visibility":"show","key":"Z3ZsC4HNDF"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-10-13T13:54:31.529797Z","iopub.status.busy":"2025-10-13T13:54:31.529115Z","iopub.status.idle":"2025-10-13T13:54:31.532571Z","shell.execute_reply":"2025-10-13T13:54:31.532206Z"},"papermill":{"duration":0.007005,"end_time":"2025-10-13T13:54:31.533192","exception":false,"start_time":"2025-10-13T13:54:31.526187","status":"completed"},"tags":["parameters"]},"children":[{"type":"code","lang":"python","executable":true,"value":"case_name = \"\"  # \"/glade/campaign/cgd/oce/projects/CROCODILE/workshops/2025/Diagnostics/CESM_Output/\"\nCESM_output_dir = \"\"  # \"CROCODILE_tutorial_nwa12_MARBL\"\n\n# As regional domains vary so much in purpose, simulation length, and extent, we don't want to assume a minimum duration\n## Thus, we ignore start and end dates and simply reduce/output over the whole time frame for all of the examples given.\nstart_date = None  # \"0001-01-01\"\nend_date = None  # \"0101-01-01\n\nsave_figs = False\nfig_output_dir = None\n\nlc_kwargs = {}\nserial = False\n\n## Notebook Specific Arguments\n# case_root is automatically populated in a CESM CUPiD workflow\n# If case_root is specified, and mom6_input_dir is not, INPUTDIR will be inferred from user_nl_mom in case_root\n# If mom6_input_dir is specified, case_root will be ignored\n# NOTE: If case_root and mom6_input_dir are both None, the notebook will not run\n# If obc_file_str is unspecified, defaults to \"forcing_obc_segment_00*.nc\"\ncase_root = None\nmom6_input_dir = None  # \"/glade/campaign/cgd/oce/projects/CROCODILE/workshops/2025/Diagnostics/Input_Dir/CROCODILE_tutorial_nwa12_MARBL_ocnice\"\nobc_file_str = None  # Pattern for OBC file names: \"forcing_obc_segment_00*.nc\"","visibility":"hide","key":"fnoi1KXIMX"},{"type":"outputs","id":"0a61vNmUVBBc0-wECTURn","children":[],"visibility":"show","key":"fXx88IMtYv"}],"visibility":"show","key":"u6AGb11yIw"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-10-13T13:54:31.540200Z","iopub.status.busy":"2025-10-13T13:54:31.539713Z","iopub.status.idle":"2025-10-13T13:54:31.548712Z","shell.execute_reply":"2025-10-13T13:54:31.548394Z"},"papermill":{"duration":0.01238,"end_time":"2025-10-13T13:54:31.549592","exception":false,"start_time":"2025-10-13T13:54:31.537212","status":"completed"},"tags":["injected-parameters"]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Parameters\ncase_name = \"CROCODILE_tutorial_nwa12_MARBL\"\nCESM_output_dir = (\n    \"/glade/campaign/cgd/oce/projects/CROCODILE/workshops/2025/Diagnostics/CESM_Output/\"\n)\nstart_date = \"\"\nend_date = \"\"\nsave_figs = True\nfig_output_dir = None\nlc_kwargs = {\"threads_per_worker\": 1}\nserial = True\ncase_root = None\nmom6_input_dir = \"/glade/campaign/cgd/oce/projects/CROCODILE/workshops/2025/Diagnostics/Input_Dir/CROCODILE_tutorial_nwa12_MARBL_ocnice\"\nobc_file_str = \"forcing_obc_segment_00*.nc\"\nsubset_kwargs = {}\nproduct = \"/glade/work/ajanney/crocodile_2025/CUPiD/examples/regional_ocean/computed_notebooks//ocn/Regional_Ocean_OBC.ipynb\"\n","visibility":"show","key":"PrJGx5cFBb"},{"type":"outputs","id":"2sfxZ_G2F7TDZJ4T1TgLz","children":[],"visibility":"show","key":"GolbMzeFu3"}],"visibility":"show","key":"GJ1x79ws1d"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-10-13T13:54:31.560964Z","iopub.status.busy":"2025-10-13T13:54:31.560462Z","iopub.status.idle":"2025-10-13T13:54:31.563930Z","shell.execute_reply":"2025-10-13T13:54:31.563682Z"},"papermill":{"duration":0.012591,"end_time":"2025-10-13T13:54:31.564522","exception":false,"start_time":"2025-10-13T13:54:31.551931","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"OUTDIR = f\"{CESM_output_dir}/{case_name}/ocn/hist/\"\nprint(\"Output directory is:\", OUTDIR)","visibility":"hide","key":"Urp7dBuO9n"},{"type":"outputs","id":"GGTCoGG-OzRcDsdiRx0Lh","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Output directory is: /glade/campaign/cgd/oce/projects/CROCODILE/workshops/2025/Diagnostics/CESM_Output//CROCODILE_tutorial_nwa12_MARBL/ocn/hist/\n"},"children":[],"key":"e7fvzHydSd"}],"visibility":"show","key":"uzzdXLL6YI"}],"visibility":"show","key":"DBfPNsn8vG"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-10-13T13:54:31.571124Z","iopub.status.busy":"2025-10-13T13:54:31.570858Z","iopub.status.idle":"2025-10-13T13:54:37.943297Z","shell.execute_reply":"2025-10-13T13:54:37.943018Z"},"papermill":{"duration":6.375769,"end_time":"2025-10-13T13:54:37.943886","exception":false,"start_time":"2025-10-13T13:54:31.568117","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"case_output_dir = os.path.join(CESM_output_dir, case_name, \"ocn\", \"hist\")\n\n# Xarray time decoding things\ntime_coder = xr.coders.CFDatetimeCoder(use_cftime=True)\n\n## Static data includes hgrid, vgrid, bathymetry, land/sea mask\nstatic_data = xr.open_mfdataset(\n    os.path.join(case_output_dir, f\"*static.nc\"),\n    decode_timedelta=True,\n    decode_times=time_coder,\n)\n\n## Surface Data\nsfc_data = xr.open_mfdataset(\n    os.path.join(case_output_dir, f\"*sfc*.nc\"),\n    decode_timedelta=True,\n    decode_times=time_coder,\n)\n\n# ## Monthly Domain Data\n# monthly_data = xr.open_mfdataset(\n#     os.path.join(case_output_dir, f\"*z*.nc\"),\n#     decode_timedelta=True,\n#     decode_times=time_coder,\n# )\n\n# ## Native Monthly Domain Data\n# native_data = xr.open_mfdataset(\n#     os.path.join(case_output_dir, f\"*native*.nc\"),\n#     decode_timedelta=True,\n#     decode_times=time_coder,\n# )\n\n## Image/Gif Output Directory\nif fig_output_dir is None:\n    image_output_dir = os.path.join(\n        \"/glade/derecho/scratch/\",\n        os.environ[\"USER\"],\n        \"archive\",\n        case_name,\n        \"ocn\",\n        \"cupid_images\",\n    )\nelse:\n    image_output_dir = os.path.join(fig_output_dir, case_name, \"ocn\", \"cupid_images\")\nif not os.path.exists(image_output_dir):\n    os.makedirs(image_output_dir)\nprint(\"Image output directory is:\", image_output_dir)","visibility":"hide","key":"ND7aQL6tBN"},{"type":"outputs","id":"zlu1oCbsosv1WB2ijYAkR","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Image output directory is: /glade/derecho/scratch/ajanney/archive/CROCODILE_tutorial_nwa12_MARBL/ocn/cupid_images\n"},"children":[],"key":"KcrL9J6j1K"}],"visibility":"show","key":"SKCl6QIVBg"}],"visibility":"show","key":"Lcq5WgmtT5"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-10-13T13:54:37.960156Z","iopub.status.busy":"2025-10-13T13:54:37.959402Z","iopub.status.idle":"2025-10-13T13:54:37.963332Z","shell.execute_reply":"2025-10-13T13:54:37.962998Z"},"papermill":{"duration":0.016402,"end_time":"2025-10-13T13:54:37.963994","exception":false,"start_time":"2025-10-13T13:54:37.947592","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"## Apply time boundaries\nif len(start_date) > 0 and len(end_date) > 0:\n    import cftime\n\n    calendar = sfc_data.time.encoding.get(\"calendar\", \"standard\")\n\n    calendar_map = {\n        \"gregorian\": cftime.DatetimeProlepticGregorian,\n        \"noleap\": cftime.DatetimeNoLeap,\n    }\n\n    CFTime = calendar_map.get(calendar, cftime.DatetimeGregorian)\n    y, m, d = [int(i) for i in start_date.split(\"-\")]\n    start_date_time = CFTime(y, m, d)\n    y, m, d = [int(i) for i in end_date.split(\"-\")]\n    end_date_time = CFTime(y, m, d)\n\n    sfc_data = sfc_data.sel(time=slice(start_date_time, end_date_time))","visibility":"show","key":"BytFA1MYEd"},{"type":"outputs","id":"ry7Fq_lmF3WThb1e3sRMF","children":[],"visibility":"show","key":"TtDv72PkDw"}],"visibility":"show","key":"bKKuxmi64H"},{"type":"block","kind":"notebook-content","data":{"papermill":{"duration":0.003195,"end_time":"2025-10-13T13:54:37.973718","exception":false,"start_time":"2025-10-13T13:54:37.970523","status":"completed"},"tags":[]},"children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Accessing and Processing Open Boundary Conditions","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ir9swjNeui"}],"identifier":"accessing-and-processing-open-boundary-conditions","label":"Accessing and Processing Open Boundary Conditions","html_id":"accessing-and-processing-open-boundary-conditions","implicit":true,"key":"M2PjBEdwaO"}],"visibility":"show","key":"BI3Wl0b6WR"},{"type":"block","kind":"notebook-content","data":{"papermill":{"duration":0.011081,"end_time":"2025-10-13T13:54:37.988518","exception":false,"start_time":"2025-10-13T13:54:37.977437","status":"completed"},"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Regional MOM6 Input Directory","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qeutGCb35o"}],"identifier":"regional-mom6-input-directory","label":"Regional MOM6 Input Directory","html_id":"regional-mom6-input-directory","implicit":true,"key":"Oc1wfSqUN6"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Regional MOM6 configurations use a separate input directory containing the data for the initial state, tides, and boundary conditions. This notebook needs to access the boundary conditions. There are a couple options here:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"pNSnQJRq1G"}],"key":"hpa8awSGbq"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"We instead look for the input directory path in two locations in the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"wHBs40cLA5"},{"type":"inlineCode","value":"case_root","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"KoXBTodK2d"},{"type":"text","value":" directory:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"OmK8MOOs0k"}],"key":"yCVQX05MhW"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":6,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"user_nl_mom","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"E1dLFj4Ycw"}],"key":"MvEbrN0Isp"}],"key":"QlqOYrNQHt"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"Buildconf/momconf/MOM_input","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"r9pFAi6hPa"}],"key":"mxXdMmBBtx"}],"key":"RHkSJd7UvE"}],"key":"Vr8bEEyvbr"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"In both files, the input directory path should have the name ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"QlqNjASPPv"},{"type":"inlineCode","value":"INPUTDIR","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"i9RFn2yvth"},{"type":"text","value":". If this path cannot be found, the rest of this notebook will fail to run, but the user can manually set the input directory path below.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"E3vVoZiqJ6"}],"key":"Mo9bwnhyL3"}],"visibility":"show","key":"II7MHUyJCn"},{"type":"block","kind":"notebook-content","data":{"tags":["papermill-error-cell-tag"]},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"span","identifier":"papermill-error-cell","label":"papermill-error-cell","style":{"color":"red","fontFamily":"Helvetica Neue, Helvetica, Arial, sans-serif","fontSize":"2em"},"children":[{"type":"text","value":"Execution using papermill encountered an exception here and stopped:","key":"DyLMDSgwTQ"}],"html_id":"papermill-error-cell","key":"CuUctRhoLJ"}],"key":"jXXjhGCDxJ"}],"visibility":"show","key":"e3HjEdQGPh"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-10-13T13:54:38.004872Z","iopub.status.busy":"2025-10-13T13:54:38.004575Z","iopub.status.idle":"2025-10-13T13:54:38.464036Z","shell.execute_reply":"2025-10-13T13:54:38.463064Z"},"papermill":{"duration":0.470023,"end_time":"2025-10-13T13:54:38.464496","exception":true,"start_time":"2025-10-13T13:54:37.994473","status":"failed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"input_dir = None\n\nfor file in [\"user_nl_mom\", \"BuildConf/momconf/MOM_input\"]:\n    filepath = Path(os.path.join(case_root, file))\n\n    if filepath.is_file():\n        with open(filepath, \"r\") as f:\n            for line in f:\n                if line.strip().startswith(\"INPUTDIR\"):\n                    key, value = line.split(\"=\", 1)\n\n                    input_dir = value.strip()\n                    break\n\n    if Path(input_dir).is_dir():\n        print(f\"Found INPUTDIR in {file}\")\n        break\n\n# Override if autmatic method doesn't work:\n# input_dir = user/specified/path\n\nif input_dir is None:\n    print(\n        \"INPUTDIR not found. Try Setting it manually in the `Regional_Ocean_OBC` notebook.\"\n    )\n    raise FileNotFoundError(\n        \"INPUTDIR not found. Try Setting it manually in the `Regional_Ocean_OBC` notebook.\"\n    )\n\nprint(f\"INPUTDIR: {input_dir}\")","visibility":"show","key":"pI9UGV1Lov"},{"type":"outputs","id":"MCSWUdJpDJ45LC0YFJvYy","children":[{"type":"output","jupyter_data":{"ename":"TypeError","evalue":"expected str, bytes or os.PathLike object, not NoneType","output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mTypeError\u001b[39m                                 Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[7]\u001b[39m\u001b[32m, line 4\u001b[39m\n\u001b[32m      1\u001b[39m input_dir = \u001b[38;5;28;01mNone\u001b[39;00m\n\u001b[32m      3\u001b[39m \u001b[38;5;28;01mfor\u001b[39;00m file \u001b[38;5;129;01min\u001b[39;00m [\u001b[33m\"\u001b[39m\u001b[33muser_nl_mom\u001b[39m\u001b[33m\"\u001b[39m, \u001b[33m\"\u001b[39m\u001b[33mBuildConf/momconf/MOM_input\u001b[39m\u001b[33m\"\u001b[39m]:\n\u001b[32m----> \u001b[39m\u001b[32m4\u001b[39m     filepath = Path(\u001b[43mos\u001b[49m\u001b[43m.\u001b[49m\u001b[43mpath\u001b[49m\u001b[43m.\u001b[49m\u001b[43mjoin\u001b[49m\u001b[43m(\u001b[49m\u001b[43mcase_root\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mfile\u001b[49m\u001b[43m)\u001b[49m)\n\u001b[32m      6\u001b[39m     \u001b[38;5;28;01mif\u001b[39;00m filepath.is_file():\n\u001b[32m      7\u001b[39m         \u001b[38;5;28;01mwith\u001b[39;00m \u001b[38;5;28mopen\u001b[39m(filepath, \u001b[33m\"\u001b[39m\u001b[33mr\u001b[39m\u001b[33m\"\u001b[39m) \u001b[38;5;28;01mas\u001b[39;00m f:\n\n\u001b[36mFile \u001b[39m\u001b[32m/glade/work/ajanney/conda-envs/cupid-analysis/lib/python3.11/posixpath.py:76\u001b[39m, in \u001b[36mjoin\u001b[39m\u001b[34m(a, *p)\u001b[39m\n\u001b[32m     71\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34mjoin\u001b[39m(a, *p):\n\u001b[32m     72\u001b[39m \u001b[38;5;250m    \u001b[39m\u001b[33;03m\"\"\"Join two or more pathname components, inserting '/' as needed.\u001b[39;00m\n\u001b[32m     73\u001b[39m \u001b[33;03m    If any component is an absolute path, all previous path components\u001b[39;00m\n\u001b[32m     74\u001b[39m \u001b[33;03m    will be discarded.  An empty last part will result in a path that\u001b[39;00m\n\u001b[32m     75\u001b[39m \u001b[33;03m    ends with a separator.\"\"\"\u001b[39;00m\n\u001b[32m---> \u001b[39m\u001b[32m76\u001b[39m     a = os.fspath(a)\n\u001b[32m     77\u001b[39m     sep = _get_sep(a)\n\u001b[32m     78\u001b[39m     path = a\n\n\u001b[31mTypeError\u001b[39m: expected str, bytes or os.PathLike object, not NoneType"},"children":[],"key":"sMhRUuctm0"}],"visibility":"show","key":"ymZCQjpXMY"}],"visibility":"show","key":"DgHVLO58y3"},{"type":"block","kind":"notebook-content","data":{"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Check for Boundary Conditions, Verify Horizontal Grid","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nmqgByuhmA"}],"identifier":"check-for-boundary-conditions-verify-horizontal-grid","label":"Check for Boundary Conditions, Verify Horizontal Grid","html_id":"check-for-boundary-conditions-verify-horizontal-grid","implicit":true,"key":"pWv1lJnpTs"}],"visibility":"show","key":"Xudz7nJsAy"},{"type":"block","kind":"notebook-content","data":{"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The input directory should contain a few different files:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"z5Z3ijcxlE"}],"key":"h7xVDYBMPW"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":2,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"init*","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"S3zx0FCGEX"},{"type":"text","value":": initial fields","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"ccGwQlh7FY"}],"key":"jo5m0J2OqS"}],"key":"BuXJfUr36V"},{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"ocean_hgrid.nc","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"h4nUt7IuaA"},{"type":"text","value":", ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"iNC9aEBMNB"},{"type":"inlineCode","value":"ocean_topo.nc","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"QyzsG8XD9H"},{"type":"text","value":", ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"QOK6GKqIJS"},{"type":"inlineCode","value":"vgrid*.nc","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jvLLYDZC03"},{"type":"text","value":": grids and bathymetry","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"WxjacJoWP5"}],"key":"lM9yHxlGoY"}],"key":"cUQOr5Yac3"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"tu*","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"ZNvxL6ZALW"},{"type":"text","value":" and ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"uwovcUrkvw"},{"type":"inlineCode","value":"tz*","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"TbwcjuoWab"},{"type":"text","value":": tidal forcing","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"weNCNL0kY4"}],"key":"sbL2Qxe8xQ"}],"key":"y7RIZXhMBu"}],"key":"ZznDwhwsv4"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"What we care about:","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"aVx58OXSY0"}],"key":"FgiTSEUzAg"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"inlineCode","value":"forcing_obc_segment*.nc","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"F0sQcqCVr1"}],"key":"Xu55177jBk"},{"type":"text","value":": open boundary conditions to force the model","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"eOIM8QtHvB"}],"key":"HSJfLQ7eS4"}],"key":"bjfekxy8H0"}],"key":"ZSSt3QtECU"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"The numbers at the end of the file each correspond to a different edge of the domain.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"sXCnfVy6gb"}],"key":"BLSbJJbvFp"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":10,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"001: south","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"lHnhj7XSSQ"}],"key":"IscKBkZ3si"}],"key":"cbAcQlyOEN"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"002: north","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"bmgzbdGUJU"}],"key":"B61KY3Ck2v"}],"key":"vQlnvD3UKA"},{"type":"listItem","spread":true,"position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"003: west","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"ydbAVYUCXv"}],"key":"zMyNBuuavh"}],"key":"hV1IzvMV7W"},{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"004: east","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"LpK4r4kT4r"}],"key":"QitVl55Iie"}],"key":"w9w4xM2bRU"}],"key":"EHmIIFeTyP"}],"visibility":"show","key":"nHzFi7UhdI"},{"type":"block","kind":"notebook-code","data":{"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"boundary_conds = glob.glob(os.path.join(input_dir, \"forcing_obc_segment_*.nc\"))\nprint(f\"Found {len(boundary_conds)} OBC files:\", boundary_conds)\n\nif len(boundary_conds) == 0:\n    raise FileNotFoundError(f\"No boundary condition files found at {input_dir}\")","visibility":"show","key":"JEMl3xxeM0"},{"type":"outputs","id":"62nQVyf_JRnzdd_NQh8t8","children":[],"visibility":"show","key":"dFDuTwx777"}],"visibility":"show","key":"fdjneGJqF7"},{"type":"block","kind":"notebook-content","data":{"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Opening and Checking Open Boundary Conditions","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"r85cF4hPva"}],"identifier":"opening-and-checking-open-boundary-conditions","label":"Opening and Checking Open Boundary Conditions","html_id":"opening-and-checking-open-boundary-conditions","implicit":true,"key":"xIZRtGtKe8"}],"visibility":"show","key":"rlbI9w1hNt"},{"type":"block","kind":"notebook-code","data":{"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"segment_num_to_dir = {\n    \"001\": \"south\",\n    \"002\": \"north\",\n    \"003\": \"west\",\n    \"004\": \"east\",\n}\nsegment_dir_to_num = {v: k for k, v in segment_num_to_dir.items()}","visibility":"show","key":"IxQUses2Wp"},{"type":"outputs","id":"KBkNhBXINhLTx72dmKclN","children":[],"visibility":"show","key":"SKGFZW0rxE"}],"visibility":"show","key":"nTyHhmTHbd"},{"type":"block","kind":"notebook-code","data":{"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"list_boundaries = []\ntemp_time_slice = slice(0, 5)\n\nfor boundary_file in boundary_conds:\n\n    boundary = xr.open_mfdataset(boundary_file)\n\n    # Temp time slice\n    boundary = boundary.isel(time=temp_time_slice)\n\n    code = (boundary_file.split(\"_\")[-1]).split(\".\")[0]\n    bound = segment_num_to_dir[code]\n\n    # Variables on the U/V grid (corners)\n    uv_vars = [f\"u_segment_{code}\", f\"v_segment_{code}\"]\n\n    # Variables on the T grid (cell center)\n    tracer_vars = [\n        f\"salt_segment_{code}\",\n        f\"temp_segment_{code}\",\n        f\"eta_segment_{code}\",\n    ]\n\n    # Create separate datasets for each grid type\n    boundary_uv = boundary[uv_vars]\n    boundary_t = boundary[tracer_vars]\n\n    # Rename coordinates for both datasets\n    boundary_uv = boundary_uv.rename(\n        {\n            f\"ny_segment_{code}\": \"yq\",\n            f\"nx_segment_{code}\": \"xq\",\n            f\"lon_segment_{code}\": \"longitude_q\",\n            f\"lat_segment_{code}\": \"latitude_q\",\n        }\n    )\n    boundary_t = boundary_t.rename(\n        {\n            f\"ny_segment_{code}\": \"yh\",\n            f\"nx_segment_{code}\": \"xh\",\n            f\"lon_segment_{code}\": \"longitude_h\",\n            f\"lat_segment_{code}\": \"latitude_h\",\n        }\n    )\n\n    # Drop variables and handle squeeze for both\n    boundary_uv = boundary_uv.drop_vars([\"nxp\", \"nyp\"])\n    boundary_t = boundary_t.drop_vars([\"nxp\", \"nyp\"])\n\n    if bound in [\"north\", \"south\"]:\n        # Slicing for a C-grid\n        boundary_uv = boundary_uv.isel(xq=slice(0, None, 2))\n        boundary_t = boundary_t.isel(xh=slice(1, None, 2))\n\n        # Assign new coordinates\n        boundary_uv = boundary_uv.assign_coords(\n            xq=(\"xq\", boundary_uv[\"longitude_q\"].values)\n        )\n        boundary_t = boundary_t.assign_coords(\n            xh=(\"xh\", boundary_t[\"longitude_h\"].values)\n        )\n\n        # boundary_uv = boundary_uv.squeeze('yq', drop = True)\n        # boundary_t = boundary_t.squeeze('yh', drop = True)\n    else:\n        # Slicing for a C-grid\n        boundary_uv = boundary_uv.isel(yq=slice(0, None, 2))\n        boundary_t = boundary_t.isel(yh=slice(1, None, 2))\n\n        # Assign new coordinates\n        boundary_uv = boundary_uv.assign_coords(\n            yq=(\"yq\", boundary_uv[\"latitude_q\"].values)\n        )\n        boundary_t = boundary_t.assign_coords(\n            yh=(\"yh\", boundary_t[\"latitude_h\"].values)\n        )\n\n        # boundary_uv = boundary_uv.squeeze('xq', drop = True)\n        # boundary_t = boundary_t.squeeze('xh', drop = True)\n\n    # Combine the processed datasets\n    boundary = xr.merge([boundary_uv, boundary_t])\n\n    # Remove longitude and latitude variables from the datasets\n    for coord in [\"longitude_q\", \"latitude_q\"]:\n        if coord in boundary:\n            boundary = boundary.drop_vars(coord)\n    for coord in [\"longitude_h\", \"latitude_h\"]:\n        if coord in boundary:\n            boundary = boundary.drop_vars(coord)\n\n    # Dumb check to make sure OBCs are on the same grid as model output\n    model_xh = static_data[\"xh\"]\n    model_yh = static_data[\"yh\"]\n    model_xq = static_data[\"xq\"]\n    model_yq = static_data[\"yq\"]\n\n    # if boundary['xh'].size > 1: assert np.allclose(boundary['xh'].values, model_xh.values, atol=1e-6), f\"Boundary {bound} x-coordinates do not match model grid\"\n    # if boundary['yh'].size > 1: assert np.allclose(boundary['yh'].values, model_yh.values, atol=1e-6), f\"Boundary {bound} y-coordinates do not match model grid\"\n    # if boundary['xq'].size > 1: assert np.allclose(boundary['xq'].values, model_xq.values, atol=1e-6), f\"Boundary {bound} corner x-coordinates do not match model grid\"\n    # if boundary['yq'].size > 1: assert np.allclose(boundary['yq'].values, model_yq.values, atol=1e-6), f\"Boundary {bound} corner y-coordinates do not match model grid\"\n\n    z_map = [\n        f\"nz_segment_{code}_u\",\n        f\"nz_segment_{code}_v\",\n        f\"nz_segment_{code}_temp\",\n        f\"nz_segment_{code}_salt\",\n    ]\n    new_boundary = {}\n    for var in boundary.data_vars:\n        da = boundary[var]\n        da.load()\n\n        zdim = [str(d) for d in da.dims if str(d) in z_map]\n        if len(zdim) > 0:\n            da = da.rename({zdim[0]: \"z_l\"})\n        new_boundary[var.split(\"_\")[0]] = da\n\n    new_boundary = xr.Dataset(new_boundary).expand_dims(boundary=[bound])\n    list_boundaries.append(new_boundary)\n\n# boundaries = xr.concat(list_boundaries, dim = 'boundary')","visibility":"show","key":"x8gKKRKPuf"},{"type":"outputs","id":"DAa_gcDAicplB3e4pfYCh","children":[],"visibility":"show","key":"C0nXOgi6SY"}],"visibility":"show","key":"fKX0tBUHiG"},{"type":"block","kind":"notebook-code","data":{"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"list_boundaries[1]","visibility":"show","key":"QsZEeWO87u"},{"type":"outputs","id":"q6kA6Xe5S39Rm4AwFIAM1","children":[],"visibility":"show","key":"bx8SbgK7Si"}],"visibility":"show","key":"dkpHkZhNk4"},{"type":"block","kind":"notebook-code","data":{"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"static_data","visibility":"show","key":"hSKPLaymf9"},{"type":"outputs","id":"-PdUh3gg7O6kj8XV0PAiQ","children":[],"visibility":"show","key":"ADHKNZgQ1e"}],"visibility":"show","key":"r2ZG4c65Sz"}],"key":"riaFhhDLhn"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Regional Ocean: Atmospheric Forcing","url":"/notebooks/diagnostics/cupid-output/regional-ocean-atmospheric-forcing","group":"Basic CrocoDash Tutorial"},"next":{"title":"Model-Observations Comparison","url":"/notebooks/projects/model-obs-comparison","group":"Basic CrocoDash Tutorial"}}},"domain":"http://localhost:3000"}