{"version":3,"kind":"Notebook","sha256":"077b29fd3501b7a83691b6653d7c50b8e788823837ca30a94a1b42f0941a3178","slug":"notebooks.diagnostics.cupid-output.regional-ocean-atmospheric-forcing","location":"/notebooks/diagnostics/cupid_output/Regional_Ocean_Atmospheric_Forcing.ipynb","dependencies":[],"frontmatter":{"title":"Regional Ocean: Atmospheric Forcing","content_includes_title":true,"kernelspec":{"name":"cupid-analysis","display_name":"cupid-analysis","language":"python"},"github":"https://github.com/CROCODILE-CESM/CrocoGallery","numbering":{"title":{"offset":3}},"source_url":"https://github.com/CROCODILE-CESM/CrocoGallery/blob/main/gallery/notebooks/diagnostics/cupid_output/Regional_Ocean_Atmospheric_Forcing.ipynb","edit_url":"https://github.com/CROCODILE-CESM/CrocoGallery/edit/main/gallery/notebooks/diagnostics/cupid_output/Regional_Ocean_Atmospheric_Forcing.ipynb","exports":[{"format":"ipynb","filename":"Regional_Ocean_Atmospheric_Forcing.ipynb","url":"/CrocoGallery/latest/build/Regional_Ocean_Atmos-ed9c7266f597646549fd603eeb54897d.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","data":{"papermill":{"duration":0.004711,"end_time":"2025-10-13T13:52:48.533857","exception":false,"start_time":"2025-10-13T13:52:48.529146","status":"completed"},"tags":[]},"children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Regional Ocean: Atmospheric Forcing","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"J1P6KDa2Y2"}],"identifier":"regional-ocean-atmospheric-forcing","label":"Regional Ocean: Atmospheric Forcing","html_id":"regional-ocean-atmospheric-forcing","implicit":true,"key":"ZMAGKvvAhj"}],"visibility":"show","key":"XmQlePAVSW"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-10-13T13:52:48.540512Z","iopub.status.busy":"2025-10-13T13:52:48.540334Z","iopub.status.idle":"2025-10-13T13:52:52.510260Z","shell.execute_reply":"2025-10-13T13:52:52.509862Z"},"papermill":{"duration":3.974286,"end_time":"2025-10-13T13:52:52.511162","exception":false,"start_time":"2025-10-13T13:52:48.536876","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"%load_ext autoreload\n%autoreload 2\n\nimport xarray as xr\nimport os\nimport cartopy.crs as ccrs\nimport cartopy\nimport matplotlib.pyplot as plt\n\nimport regional_utils as utils","visibility":"hide","key":"DSo5NNaj51"},{"type":"outputs","id":"CB03cJOFQfF4VUXjLnd2N","children":[],"visibility":"show","key":"iOiOFMnUc5"}],"visibility":"show","key":"o1M0EgY2MS"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-10-13T13:52:52.517858Z","iopub.status.busy":"2025-10-13T13:52:52.517261Z","iopub.status.idle":"2025-10-13T13:52:52.545587Z","shell.execute_reply":"2025-10-13T13:52:52.545271Z"},"papermill":{"duration":0.031128,"end_time":"2025-10-13T13:52:52.546481","exception":false,"start_time":"2025-10-13T13:52:52.515353","status":"completed"},"tags":["parameters"]},"children":[{"type":"code","lang":"python","executable":true,"value":"case_name = \"\"  # \"/glade/campaign/cgd/oce/projects/CROCODILE/workshops/2025/Diagnostics/CESM_Output/\"\nCESM_output_dir = \"\"  # \"CROCODILE_tutorial_nwa12_MARBL\"\n\n# As regional domains vary so much in purpose, simulation length, and extent, we don't want to assume a minimum duration\n## Thus, we ignore start and end dates and simply reduce/output over the whole time frame for all of the examples given.\nstart_date = None  # \"0001-01-01\"\nend_date = None  # \"0101-01-01\n\nsave_figs = False\nfig_output_dir = None\n\nlc_kwargs = {}\nserial = False\n\natm_variables = []  # ['tauuo', 'tauvo', 'hfds']\nocn_variables = []  # ['uo', 'vo', 'thetao']","visibility":"hide","key":"VYNx2IMlL2"},{"type":"outputs","id":"2eNBGzd6ZZ6CuImpv7vQ8","children":[],"visibility":"show","key":"xTB0THOxME"}],"visibility":"show","key":"gBghsR1GYu"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-10-13T13:52:52.550954Z","iopub.status.busy":"2025-10-13T13:52:52.550328Z","iopub.status.idle":"2025-10-13T13:52:52.576322Z","shell.execute_reply":"2025-10-13T13:52:52.575978Z"},"papermill":{"duration":0.028972,"end_time":"2025-10-13T13:52:52.577191","exception":false,"start_time":"2025-10-13T13:52:52.548219","status":"completed"},"tags":["injected-parameters"]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Parameters\ncase_name = \"CROCODILE_tutorial_nwa12_MARBL\"\nCESM_output_dir = (\n    \"/glade/campaign/cgd/oce/projects/CROCODILE/workshops/2025/Diagnostics/CESM_Output/\"\n)\nstart_date = \"\"\nend_date = \"\"\nsave_figs = True\nfig_output_dir = None\nlc_kwargs = {\"threads_per_worker\": 1}\nserial = True\natm_variables = [\"tauuo\", \"tauvo\", \"hfds\"]\nocn_variables = [\"uo\", \"vo\", \"thetao\"]\nsubset_kwargs = {}\nproduct = \"/glade/work/ajanney/crocodile_2025/CUPiD/examples/regional_ocean/computed_notebooks//ocn/Regional_Ocean_Atmospheric_Forcing.ipynb\"\n","visibility":"show","key":"fUHVCDsh5t"},{"type":"outputs","id":"NMPhbkBuKX51LhTP2KDEM","children":[],"visibility":"show","key":"HxthQEeU68"}],"visibility":"show","key":"ShRjqF7GmF"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-10-13T13:52:52.581116Z","iopub.status.busy":"2025-10-13T13:52:52.580666Z","iopub.status.idle":"2025-10-13T13:52:52.609162Z","shell.execute_reply":"2025-10-13T13:52:52.608724Z"},"papermill":{"duration":0.030978,"end_time":"2025-10-13T13:52:52.609840","exception":false,"start_time":"2025-10-13T13:52:52.578862","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"OUTDIR = f\"{CESM_output_dir}/{case_name}/ocn/hist/\"\nprint(\"Output directory is:\", OUTDIR)","visibility":"hide","key":"VI8cjdYnpf"},{"type":"outputs","id":"PJhjCNXXYJ5QifyI9YBk8","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Output directory is: /glade/campaign/cgd/oce/projects/CROCODILE/workshops/2025/Diagnostics/CESM_Output//CROCODILE_tutorial_nwa12_MARBL/ocn/hist/\n"},"children":[],"key":"iYo4xcb7mA"}],"visibility":"show","key":"P4cKYTuKLY"}],"visibility":"show","key":"Ba3JD7Et5E"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-10-13T13:52:52.614838Z","iopub.status.busy":"2025-10-13T13:52:52.614404Z","iopub.status.idle":"2025-10-13T13:53:01.888457Z","shell.execute_reply":"2025-10-13T13:53:01.888124Z"},"papermill":{"duration":9.276681,"end_time":"2025-10-13T13:53:01.889190","exception":false,"start_time":"2025-10-13T13:52:52.612509","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"case_output_dir = os.path.join(CESM_output_dir, case_name, \"ocn\", \"hist\")\n\n# Xarray time decoding things\ntime_coder = xr.coders.CFDatetimeCoder(use_cftime=True)\n\n## Static data includes hgrid, vgrid, bathymetry, land/sea mask\nstatic_data = xr.open_mfdataset(\n    os.path.join(case_output_dir, f\"*static.nc\"),\n    decode_timedelta=True,\n    decode_times=time_coder,\n    engine=\"netcdf4\",\n)\n\n# ## Surface Data\n# sfc_data = xr.open_mfdataset(\n#     os.path.join(case_output_dir, f\"*sfc*.nc\"),\n#     decode_timedelta=True,\n#     decode_times=time_coder,\n#     engine=\"netcdf4\",\n# )\n\n## Native Monthly Domain Data (and atm forcing)\nmonthly_data = xr.open_mfdataset(\n    os.path.join(case_output_dir, f\"*h.z*.nc\"),\n    decode_timedelta=True,\n    decode_times=time_coder,\n    engine=\"netcdf4\",\n)\n\n## Native Monthly Domain Data (and atm forcing)\nnative_data = xr.open_mfdataset(\n    os.path.join(case_output_dir, f\"*native*.nc\"),\n    decode_timedelta=True,\n    decode_times=time_coder,\n    engine=\"netcdf4\",\n)\n\n## Image/Gif Output Directory\nif fig_output_dir is None:\n    image_output_dir = os.path.join(\n        \"/glade/derecho/scratch/\",\n        os.environ[\"USER\"],\n        \"archive\",\n        case_name,\n        \"ocn\",\n        \"cupid_images\",\n    )\nelse:\n    image_output_dir = os.path.join(fig_output_dir, case_name, \"ocn\", \"cupid_images\")\nif not os.path.exists(image_output_dir):\n    os.makedirs(image_output_dir)\nprint(\"Image output directory is:\", image_output_dir)","visibility":"hide","key":"OfVFgyMHSV"},{"type":"outputs","id":"CT0r4_PoM8VEUMSvqPakX","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Image output directory is: /glade/derecho/scratch/ajanney/archive/CROCODILE_tutorial_nwa12_MARBL/ocn/cupid_images\n"},"children":[],"key":"HpTthWikj7"}],"visibility":"show","key":"g94d8cvxes"}],"visibility":"show","key":"yjphDSN13y"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-10-13T13:53:01.897209Z","iopub.status.busy":"2025-10-13T13:53:01.896679Z","iopub.status.idle":"2025-10-13T13:53:01.968174Z","shell.execute_reply":"2025-10-13T13:53:01.967706Z"},"papermill":{"duration":0.074639,"end_time":"2025-10-13T13:53:01.968866","exception":false,"start_time":"2025-10-13T13:53:01.894227","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"## Select for only the variables we want to analyze\nif len(atm_variables) > 0:\n    print(\"Selecting only the following surface variables:\", atm_variables)\n    native_data = native_data[atm_variables]\nif len(ocn_variables) > 0:\n    print(\"Selecting only the following monthly variables:\", ocn_variables)\n    monthly_data = monthly_data[ocn_variables]\n\n## Apply time boundaries\n## if they are the right format\nif len(start_date.split(\"-\")) == 3 and len(end_date.split(\"-\")) == 3:\n    import cftime\n\n    calendar = monthly_data.time.encoding.get(\"calendar\", \"standard\")\n\n    calendar_map = {\n        \"gregorian\": cftime.DatetimeProlepticGregorian,\n        \"noleap\": cftime.DatetimeNoLeap,\n    }\n\n    CFTime = calendar_map.get(calendar, cftime.DatetimeGregorian)\n    y, m, d = [int(i) for i in start_date.split(\"-\")]\n    start_date_time = CFTime(y, m, d)\n    y, m, d = [int(i) for i in end_date.split(\"-\")]\n    end_date_time = CFTime(y, m, d)\n\n    print(\n        f\"Applying time range from start_date: {start_date_time} and end_date: {end_date_time}.\"\n    )\n\n    monthly_data = monthly_data.sel(time=slice(start_date_time, end_date_time))\n    native_data = native_data.sel(time=slice(start_date_time, end_date_time))\n\nnative_time_bounds = [\n    native_data[\"time\"].isel(time=0).compute().item(),\n    native_data[\"time\"].isel(time=-1).compute().item(),\n]\nmonthly_time_bounds = [\n    monthly_data[\"time\"].isel(time=0).compute().item(),\n    monthly_data[\"time\"].isel(time=-1).compute().item(),\n]\n\nprint(f\"Surface Data Time Bounds: {native_time_bounds[0]} to {native_time_bounds[-1]}\")\nprint(\n    f\"Monthly Data Time Bounds: {monthly_time_bounds[0]} to {monthly_time_bounds[-1]}\"\n)","visibility":"show","key":"Mtsb72EGux"},{"type":"outputs","id":"FLltG_TTVg4vk-_FPE3yo","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Selecting only the following surface variables: ['tauuo', 'tauvo', 'hfds']\nSelecting only the following monthly variables: ['uo', 'vo', 'thetao']\nSurface Data Time Bounds: 2000-01-14 12:00:00 to 2000-11-14 00:00:00\nMonthly Data Time Bounds: 2000-01-14 12:00:00 to 2000-10-14 12:00:00\n"},"children":[],"key":"izJZ3pNmJi"}],"visibility":"show","key":"fUzhFh6fmJ"}],"visibility":"show","key":"PAyucKYSE0"},{"type":"block","kind":"notebook-content","data":{"papermill":{"duration":0.001499,"end_time":"2025-10-13T13:53:01.973838","exception":false,"start_time":"2025-10-13T13:53:01.972339","status":"completed"},"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Simple Visualization of Atmospheric Forcing vs Ocean Variables","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xFODfheg9x"}],"identifier":"simple-visualization-of-atmospheric-forcing-vs-ocean-variables","label":"Simple Visualization of Atmospheric Forcing vs Ocean Variables","html_id":"simple-visualization-of-atmospheric-forcing-vs-ocean-variables","implicit":true,"key":"ihs5NzibPD"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This notebook is short and sweet, designed to just show how we might access the atmospheric forcing variables. Pay particular attention to the meta data for the different variables!","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"b5PMG8KcQ7"}],"key":"wE6FVxfwZp"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Note:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ABbbfCSbBJ"}],"key":"T3UObQZXRU"},{"type":"text","value":" Native output can be weird, be wary and ask questions!","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"mQq4UPxwWH"}],"key":"LbFq7Ja0ek"}],"visibility":"show","key":"aRdb9cGnVn"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-10-13T13:53:01.978711Z","iopub.status.busy":"2025-10-13T13:53:01.978229Z","iopub.status.idle":"2025-10-13T13:54:22.896466Z","shell.execute_reply":"2025-10-13T13:54:22.896042Z"},"papermill":{"duration":80.985852,"end_time":"2025-10-13T13:54:22.962069","exception":false,"start_time":"2025-10-13T13:53:01.976217","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"for coord in list(static_data.variables):\n    if \"geolon\" in coord or \"geolat\" in coord:\n        native_data = native_data.assign_coords({coord: static_data[coord]})\n        monthly_data = monthly_data.assign_coords({coord: static_data[coord]})\n\nfor i, var in enumerate(atm_variables):\n    field = native_data[var]\n    sfc_var = ocn_variables[i]  # assuming order matches, it may not\n    sfc_field = monthly_data[sfc_var].isel(z_l=0)\n\n    geocoords = utils.chooseGeoCoords(field.dims)\n    lon = geocoords[\"longitude\"]\n    lat = geocoords[\"latitude\"]\n\n    cmap = utils.chooseColorMap(var)\n\n    transform = ccrs.PlateCarree()\n    subplot_kwargs = {\n        \"projection\": ccrs.Mercator(),\n    }\n\n    map_extent = [\n        float(field[lon].min()),\n        float(field[lon].max()),\n        float(field[lat].min()),\n        float(field[lat].max()),\n    ]\n\n    # Plot atmospheric variable for each month\n    g1 = field.plot(\n        x=lon,\n        y=lat,\n        col=\"time\",\n        col_wrap=4,\n        robust=True,\n        cmap=cmap,\n        transform=transform,\n        subplot_kws=subplot_kwargs,\n    )\n    plt.suptitle(f\"Atmosphere: {var} monthly fields\", fontsize=16, y=1.02)\n\n    for ax in g1.axs.flat:\n        ax.set_extent(map_extent, crs=ccrs.PlateCarree())\n        ax.coastlines(resolution=\"50m\", color=\"black\", linewidth=0.3)\n\n    if save_figs:\n        plt.savefig(os.path.join(image_output_dir, f\"{var}_monthly_grid.png\"))\n    plt.show()\n\n    # Plot ocean surface variable for each month\n    g2 = sfc_field.plot(\n        x=lon,\n        y=lat,\n        col=\"time\",\n        col_wrap=4,\n        robust=True,\n        cmap=cmap,\n        transform=transform,\n        subplot_kws=subplot_kwargs,\n    )\n    plt.suptitle(f\"Ocean: {sfc_var} monthly fields\", fontsize=16, y=1.02)\n\n    for ax in g2.axs.flat:\n        ax.set_extent(map_extent, crs=ccrs.PlateCarree())\n        ax.coastlines(resolution=\"50m\", color=\"black\", linewidth=0.3)\n\n    if save_figs:\n        plt.savefig(os.path.join(image_output_dir, f\"{sfc_var}_monthly_grid.png\"))\n    plt.show()","visibility":"show","key":"JtpxTzCdz0"},{"type":"outputs","id":"nWv9D2VrVWuRMCQf6NQzn","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"314d2011ffbd2779104c338ee173ccec","path":"/CrocoGallery/latest/build/314d2011ffbd2779104c338ee173ccec.png"},"text/plain":{"content":"<Figure size 2600x1800 with 13 Axes>","content_type":"text/plain"}}},"children":[],"key":"jFEWt1YABv"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"b7c9b180b83244e36d9a0b051f7868fe","path":"/CrocoGallery/latest/build/b7c9b180b83244e36d9a0b051f7868fe.png"},"text/plain":{"content":"<Figure size 2600x1800 with 13 Axes>","content_type":"text/plain"}}},"children":[],"key":"gaNmgHdflG"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"8dd7f513c47522ce29466878e99ef130","path":"/CrocoGallery/latest/build/8dd7f513c47522ce29466878e99ef130.png"},"text/plain":{"content":"<Figure size 2600x1800 with 13 Axes>","content_type":"text/plain"}}},"children":[],"key":"ojs4S9aRme"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"cb721d941507edaebe919adb64eba8a4","path":"/CrocoGallery/latest/build/cb721d941507edaebe919adb64eba8a4.png"},"text/plain":{"content":"<Figure size 2600x1800 with 13 Axes>","content_type":"text/plain"}}},"children":[],"key":"Yp1kGA6Aqd"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"c28889e6dc1a0575065813922a321eb9","path":"/CrocoGallery/latest/build/c28889e6dc1a0575065813922a321eb9.png"},"text/plain":{"content":"<Figure size 2600x1800 with 13 Axes>","content_type":"text/plain"}}},"children":[],"key":"ixgXVMqR11"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"f17a282054b2027c88e6c184b03f5b89","path":"/CrocoGallery/latest/build/f17a282054b2027c88e6c184b03f5b89.png"},"text/plain":{"content":"<Figure size 2600x1800 with 13 Axes>","content_type":"text/plain"}}},"children":[],"key":"XHNv3guR5B"}],"visibility":"show","key":"sGVL4QwgCh"}],"visibility":"show","key":"T93kTnnLV3"}],"key":"HIDov6W2pW"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Regional Ocean: Animations of Surface Fields","url":"/notebooks/diagnostics/cupid-output/regional-ocean-animations","group":"Basic CrocoDash Tutorial"},"next":{"title":"Regional Ocean: Checking Open Boundary Conditions","url":"/notebooks/diagnostics/cupid-output/regional-ocean-obc","group":"Basic CrocoDash Tutorial"}}},"domain":"http://localhost:3000"}