
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Running CUPiD within CESM &#8212; CrocoDash Gallery</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/diagnostics/CUPiD_in_CESM_Workflow';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Contributing to CUPiD" href="contributing_to_CUPiD.html" />
    <link rel="prev" title="Advanced CUPiD Tutorial" href="CUPiD_projects.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/crocodile.png" class="logo__image only-light" alt="CrocoDash Gallery - Home"/>
    <script>document.write(`<img src="../../_static/crocodile.png" class="logo__image only-dark" alt="CrocoDash Gallery - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Welcome to the CrocoDash Gallery!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorials/walkthrough.html">Basic CrocoDash Tutorial</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/cesm_setup.html">CESM Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/minimal_demo_rect.html">Set up a rectangular regional CESM-MOM6 run</a></li>




<li class="toctree-l2"><a class="reference internal" href="../tutorials/input_params.html">Input Parameters</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Feature Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../features/coupling.html">Coupling Tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../features/add_bgc.html">Run a coupled biogeochemistry (MARBL) &amp; ocean (MOM6) model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features/add_cice.html">Run a coupled sea ice (CICE) &amp; ocean (MOM6) model</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../features/custom_grid.html">Grid Customization Tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../features/subset_global.html">Add Global Subset Grids</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features/add_grids.html">Use Custom Pre-Generated Grids</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../features/data_product.html">Data Product Tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../features/too_much_data.html">Setup Iterative OBC generation (for Long CESM-MOM6 runs) w/ the  Large Data Workflow (Advanced)</a></li>

<li class="toctree-l2"><a class="reference internal" href="../features/add_data_products.html">Use different data products w/ the CrocoDash Data Access Module</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="CUPiD_for_regional_MOM6.html">CUPiD Diagnostics Tutorial</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="CUPiD_intro.html">Installing CUPiD</a></li>
<li class="toctree-l2"><a class="reference internal" href="standalone_CUPiD.html">Running a CUPiD Example</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../features/add_components.html">Additional Component Tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../features/add_rof.html">Add data runoff from GLOFAS to the Run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features/add_runoff_product.html">Adding your own runoff product to the CESM (Advanced)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features/add_chl.html">Add Chlorophyll Files to the Run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features/add_tides.html">Add Boundary Tides to the Run</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">2025 CROCODILE Workshop Projects</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../projects/NWA.html">NWA</a></li>

<li class="toctree-l1"><a class="reference internal" href="../projects/CICE.html">CICE-MOM6</a></li>




<li class="toctree-l1"><a class="reference internal" href="../projects/choose_your_own_adventure.html">Choose your own adventure!</a></li>




<li class="toctree-l1 current active has-children"><a class="reference internal" href="CUPiD_projects.html">Advanced CUPiD Tutorial</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Running CUPiD within CESM</a></li>
<li class="toctree-l2"><a class="reference internal" href="contributing_to_CUPiD.html">Contributing to CUPiD</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Use Cases</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../use_cases/index.html">Development Cases</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/three_boundary_from_t232.html">Make a lowres domain for DA dev work!</a></li>




<li class="toctree-l2"><a class="reference internal" href="../use_cases/three_boundary.html">Setup the NWA12 domain through CrocoDash</a></li>




<li class="toctree-l2"><a class="reference internal" href="../use_cases/mom6_cice_antarctica.html">Set up a rectangular regional CESM-MOM6-CICE coupled run</a></li>




</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/CROCODILE-CESM/CrocoGallery" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/CROCODILE-CESM/CrocoGallery/issues/new?title=Issue%20on%20page%20%2Fnotebooks/diagnostics/CUPiD_in_CESM_Workflow.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/diagnostics/CUPiD_in_CESM_Workflow.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Running CUPiD within CESM</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#task-3">Task 3:</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#task-3-1-moving-to-derecho-and-navigating-to-your-cesm-case">Task 3.1: Moving to Derecho and Navigating to your CESM case</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#moving-to-derecho">Moving to Derecho</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#navigating-to-cesm-case">Navigating to CESM Case</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#task-3-2-explore-how-cupid-is-incorporated-in-a-cesm-case">Task 3.2: Explore how CUPiD is Incorporated in a CESM Case</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#task-3-3-configure-and-run-cupid">Task 3.3: Configure and Run CUPiD</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#side-quest-how-does-cupid-tie-in-to-cesm">Side Quest: How Does CUPiD Tie in to CESM?</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="running-cupid-within-cesm">
<h1>Running CUPiD within CESM<a class="headerlink" href="#running-cupid-within-cesm" title="Link to this heading">#</a></h1>
<p>CUPiD has been included in the CESM workflow,
which means you can run CUPiD from a CESM case directory with the familiar <code class="docutils literal notranslate"><span class="pre">case.submit</span></code> command.
For this exercise, we will run the notebooks Aidan put together on the case you ran with Manish.</p>
<div class="alert" role="alert" style="background-color:rgb(255,126,185); color: #5C0029; border-color:rgb(255,126,185);">
<h4 style="margin-top: 0; padding-top: 0; display: inline-flex; color: #5C0029;"> <strong> Checkpoint! </strong> </h4> 
<ol>
<li> Are the standalone diagnostics from the previous activity done running? </li>
<li>Do you have a case that successfully ran and produced output from Monday's <strong>Practicum: Using CrocoDash</strong>? </li>
</ol>
<p>Let us know if you need any help!</p>
</div>
<section id="task-3">
<h2>Task 3:<a class="headerlink" href="#task-3" title="Link to this heading">#</a></h2>
<section id="task-3-1-moving-to-derecho-and-navigating-to-your-cesm-case">
<h3>Task 3.1: Moving to Derecho and Navigating to your CESM case<a class="headerlink" href="#task-3-1-moving-to-derecho-and-navigating-to-your-cesm-case" title="Link to this heading">#</a></h3>
<p>We have been working on NCAR’s Casper machine, which is very useful for diagnostics, data analysis, and visualization. The CESM case that we made in Monday’s practicum, <strong>Using CrocoDash</strong>, was set up to run on Derecho. CESM is picky about what machine it runs one bcause it tailors the configuration and run accordingly, so we need to move to Derecho for this next step.</p>
<section id="moving-to-derecho">
<h4>Moving to Derecho<a class="headerlink" href="#moving-to-derecho" title="Link to this heading">#</a></h4>
<p>There are two options for this step:</p>
<div class="alert alert-info">  
<details>  
<summary>A. Access Derecho through our current JupyterHub instance with <code>ssh</code>.</summary><br>
Casper is on the same network as Derecho, so in a new terminal you can simply type:
<pre> ssh USERNAME@derecho </pre>
<p>You will be prompted to enter your password and authenticate with DUO, and then you will be connected to a login node on Derecho.</p>
</div>
<div class="alert alert-info">  
<details>  
<summary>B. Access Derecho through a separate terminal with <code>ssh</code>.</summary><br>
You can directly login to Derecho through any terminal using <code>ssh</code>. Run the command:
<pre> ssh USERNAME@derecho.hpc.ucar.edu </pre>
<p>You will be prompted to enter your password and authenticate with DUO, and then you will be connected to a login node on Derecho.</p>
</div>
<p>Look for the prompt on your terminal to say <code class="docutils literal notranslate"><span class="pre">USERNAME&#64;derecho#:~&gt;</span></code>.</p>
</section>
<section id="navigating-to-cesm-case">
<h4>Navigating to CESM Case<a class="headerlink" href="#navigating-to-cesm-case" title="Link to this heading">#</a></h4>
<p>Change into the directory for your case from Monday’s practicum. The path to this directory might vary, but it will likely be located in the same <code class="docutils literal notranslate"><span class="pre">crocodile_2025</span></code> directory we have been working in so far. You will likely run a command like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>/glade/work/USERNAME/crocodile_2025/CASENAME
</pre></div>
</div>
</section>
</section>
<section id="task-3-2-explore-how-cupid-is-incorporated-in-a-cesm-case">
<h3>Task 3.2: Explore how CUPiD is Incorporated in a CESM Case<a class="headerlink" href="#task-3-2-explore-how-cupid-is-incorporated-in-a-cesm-case" title="Link to this heading">#</a></h3>
<p>As you saw in previous tutorials, CESM uses XML files to manage the environment in which your case is run.
Each file contains variables pertaining to a different phase of the case generation process:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>env_archive.xml
env_batch.xml
env_build.xml
env_case.xml
env_mach_pes.xml
env_mach_specific.xml
env_postprocessing.xml
env_run.xml
env_workflow.xml
</pre></div>
</div>
<p><strong>Note:</strong> run <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-1</span> <span class="pre">env_*</span></code> inside your CESM installation if you want to produce this output.</p>
<p>We are interested in the CUPiD variables,
which are all defined in <code class="docutils literal notranslate"><span class="pre">env_postprocessing.xml</span></code>.
XML variables are all in plain-text files so we could inspect them directly,
but let’s use the provided <code class="docutils literal notranslate"><span class="pre">xmlquery</span></code> tool instead.</p>
<div class="alert alert-warning">  
🚨 <strong>POP QUIZ #1!</strong> 🚨 
<p>How do you use <code class="docutils literal notranslate"><span class="pre">xmlquery</span></code> to see all the variables that contain <code class="docutils literal notranslate"><span class="pre">CUPID</span></code> in their name (along with their values)?</p>
<details>  
<summary>Solution</summary><br>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./xmlquery -p CUPID
Results in group cupid_analysis
	CUPID_BASELINE_CASE: b.e23_alpha17f.BLT1850.ne30_t232.092
	CUPID_BASELINE_ROOT: /glade/derecho/scratch/mlevy/archive/CAcurrent.002/..
	CUPID_BASE_NYEARS: 100
	CUPID_BASE_STARTDATE: 0001-01-01
	CUPID_EXAMPLE: key_metrics
	CUPID_NYEARS: 1
	CUPID_STARTDATE: 0001-01-01
	CUPID_TS_DIR: /glade/derecho/scratch/mlevy/archive/CAcurrent.002/..

Results in group cupid_config
	CUPID_GEN_DIAGNOSTICS: TRUE
	CUPID_GEN_HTML: TRUE
	CUPID_GEN_TIMESERIES: TRUE
	CUPID_ROOT: /glade/work/mlevy/codes/CESM/cesm3_0_alpha07c_CROCO/tools/CUPiD

Results in group cupid_environments
	CUPID_ANALYSIS_ENV: cupid-analysis
	CUPID_INFRASTRUCTURE_ENV: cupid-infrastructure

Results in group cupid_run_components
	CUPID_MEM_PER_TASK: 10
	CUPID_NTASKS: 1
	CUPID_RUN_ADF: FALSE
	CUPID_RUN_ALL: TRUE
	CUPID_RUN_ATM: FALSE
	CUPID_RUN_GLC: FALSE
	CUPID_RUN_ICE: FALSE
	CUPID_RUN_LND: FALSE
	CUPID_RUN_OCN: FALSE
	CUPID_RUN_ROF: FALSE
	CUPID_TASKS_PER_NODE: 128
</pre></div>
</div>
</details>
</div>
</section>
<section id="task-3-3-configure-and-run-cupid">
<h3>Task 3.3: Configure and Run CUPiD<a class="headerlink" href="#task-3-3-configure-and-run-cupid" title="Link to this heading">#</a></h3>
<p>The first variable to talk about is <code class="docutils literal notranslate"><span class="pre">CUPID_ROOT</span></code>.
CUPiD is distributed with CESM in the <code class="docutils literal notranslate"><span class="pre">tools/CUPiD</span></code> subdirectory,
but you may wish to use a more recent version of CUPiD.
This could be handy if, for example,
you are taking a tutorial and the first exercises were cloning CUPiD,
installing environments from this clone and then running a few examples.
In that case, you want to run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./xmlchange<span class="w"> </span><span class="nv">CUPID_ROOT</span><span class="o">=</span><span class="si">${</span><span class="nv">CUPID_ROOT</span><span class="si">}</span>
</pre></div>
</div>
<p>We also want to run the <code class="docutils literal notranslate"><span class="pre">regional_ocean</span></code> example and use 10 GB of memory.
These are set by the <code class="docutils literal notranslate"><span class="pre">CUPID_EXAMPLE</span></code> and <code class="docutils literal notranslate"><span class="pre">CUPID_MEM_PER_TASK</span></code> variables, respectively.</p>
<div class="alert alert-warning">  
🚨 <strong>POP QUIZ #2!</strong> 🚨 
<p>How do we set <code class="docutils literal notranslate"><span class="pre">CUPID_EXAMPLE</span> <span class="pre">=</span> <span class="pre">regional_ocean</span></code>?
How can we check the value of <code class="docutils literal notranslate"><span class="pre">CUPID_MEM_PER_TASK</span></code> to make sure we have enough memory?</p>
<details>  
<summary>Solution</summary><br>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./xmlchange<span class="w"> </span><span class="nv">CUPID_EXAMPLE</span><span class="o">=</span>regional_ocean
./xmlquery<span class="w"> </span>CUPID_MEM_PER_TASK
</pre></div>
</div>
</details>
</div>
<p>Lastly, we don’t need to generate time series files or build a webpage</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./xmlchange<span class="w"> </span><span class="nv">CUPID_GEN_TIMESERIES</span><span class="o">=</span>FALSE,CUPID_GEN_HTML<span class="o">=</span>FALSE
</pre></div>
</div>
<p>When you are ready to run CUPiD, you can tell <code class="docutils literal notranslate"><span class="pre">case.submit</span></code> that you want to run the <code class="docutils literal notranslate"><span class="pre">case.cupid</span></code> job in the workflow.
Make sure you are logged in to Derecho (not Casper) and then run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./case.submit<span class="w"> </span>--job<span class="w"> </span><span class="k">case</span>.cupid
</pre></div>
</div>
<p>This will add a job to the development queue on derecho,
and it hopefully will start running quickly.
When it finishes, output will be in the <code class="docutils literal notranslate"><span class="pre">computed_notebooks</span></code> subdirectory of your case directory.</p>
</section>
</section>
<section id="side-quest-how-does-cupid-tie-in-to-cesm">
<h2>Side Quest: How Does CUPiD Tie in to CESM?<a class="headerlink" href="#side-quest-how-does-cupid-tie-in-to-cesm" title="Link to this heading">#</a></h2>
<p>The details look complicated, but it’s pretty simple from the user’s perspective
(we’re going to look at several files to understand what CESM is doing,
but in practice you won’t need to modify any of them if you just want to run CUPiD).
The CESM workflow is defined in the <a class="reference external" href="https://github.com/ESMCI/ccs_config_cesm"><code class="docutils literal notranslate"><span class="pre">ccs_config_cesm</span></code></a> repository,
and the piece relevant to CUPiD is the <a class="reference external" href="https://github.com/ESMCI/ccs_config_cesm/blob/main/machines/template.cupid"><code class="docutils literal notranslate"><span class="pre">machines/template.cupid</span></code></a> file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash -e</span>

<span class="c1"># Batch system directives</span>
<span class="o">{{</span><span class="w"> </span>batchdirectives<span class="w"> </span><span class="o">}}</span>

<span class="c1"># Set environment for CESM</span>
<span class="nb">source</span><span class="w"> </span>.env_mach_specific.sh

<span class="c1"># Run shell script in CUPiD external</span>
<span class="nv">CUPID_ROOT</span><span class="o">=</span><span class="sb">`</span>./xmlquery<span class="w"> </span>--value<span class="w"> </span>CUPID_ROOT<span class="sb">`</span>
<span class="o">(</span>.<span class="w"> </span><span class="si">${</span><span class="nv">CUPID_ROOT</span><span class="si">}</span>/helper_scripts/cesm_postprocessing.sh<span class="o">)</span>
</pre></div>
</div>
<p>CIME parses everything in <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">}}</span></code> and replaces it with machine-specific code;
the final file is <code class="docutils literal notranslate"><span class="pre">case.cupid</span></code> in your case directory.
On derecho, this looks like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash -e</span>

<span class="c1"># Batch system directives</span>
<span class="c1">#PBS -N cupid.{CASE}</span>
<span class="c1">#PBS  -r n</span>
<span class="c1">#PBS  -j oe</span>
<span class="c1">#PBS  -S /bin/bash</span>
<span class="c1">#PBS  -l select=1:ncpus=1:mpiprocs=1:ompthreads=1:mem=10GB</span>

<span class="c1"># Set environment for CESM</span>
<span class="nb">source</span><span class="w"> </span>.env_mach_specific.sh

<span class="c1"># Run shell script in CUPiD external</span>
<span class="nv">CUPID_ROOT</span><span class="o">=</span><span class="sb">`</span>./xmlquery<span class="w"> </span>--value<span class="w"> </span>CUPID_ROOT<span class="sb">`</span>
<span class="o">(</span>.<span class="w"> </span><span class="si">${</span><span class="nv">CUPID_ROOT</span><span class="si">}</span>/helper_scripts/cesm_postprocessing.sh<span class="o">)</span>
</pre></div>
</div>
<p>In an attempt to keep all necessary code in the CUPiD repository,
you’ll note that the last two lines are then calling <a class="reference external" href="https://github.com/NCAR/CUPiD/blob/main/helper_scripts/cesm_postprocessing.sh"><code class="docutils literal notranslate"><span class="pre">helper_scripts/cesm_postprocessing.sh</span></code></a> out of <code class="docutils literal notranslate"><span class="pre">CUPID_ROOT</span></code>.
CUPiD’s <a class="reference external" href="https://github.com/NCAR/CUPiD/blob/main/helper_scripts/"><code class="docutils literal notranslate"><span class="pre">helper_scripts/</span></code></a> directory contains several scripts used to create configuration files,
and <code class="docutils literal notranslate"><span class="pre">cesm_postprocessing.sh</span></code> is the driver that ties everything together.
We won’t walk through the entire script here,
but I want to highlight the comments in the script that list the processes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set variables that come from environment or CESM XML files</span>

<span class="c1"># Create directory for running CUPiD</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>cupid-postprocessing
<span class="nb">cd</span><span class="w"> </span>cupid-postprocessing

<span class="c1"># Use cupid-infrastructure environment for running these scripts</span>
conda<span class="w"> </span>activate<span class="w"> </span><span class="si">${</span><span class="nv">CUPID_INFRASTRUCTURE_ENV</span><span class="si">}</span>

<span class="c1"># 1. Generate CUPiD config file</span>
<span class="si">${</span><span class="nv">CUPID_ROOT</span><span class="si">}</span>/helper_scripts/generate_cupid_config_for_cesm_case.py

<span class="c1"># 2. Generate ADF config file</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CUPID_RUN_ADF</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;TRUE&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>

<span class="c1"># 3. Generate ILAMB config file</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CUPID_RUN_ILAMB</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;TRUE&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>

<span class="c1"># 4. Generate LDF config file</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CUPID_RUN_LDF</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;TRUE&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>

<span class="c1"># 5. Generate timeseries files</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CUPID_GEN_TIMESERIES</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;TRUE&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>

<span class="c1"># 6. Run ADF</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CUPID_RUN_ADF</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;TRUE&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>

<span class="c1"># 7. Run ILAMB</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CUPID_RUN_ILAMB</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;TRUE&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>

<span class="c1"># 8. Run LDF</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CUPID_RUN_LDF</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;TRUE&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>

<span class="c1"># 9. Run CUPiD and build webpage</span>
conda<span class="w"> </span>deactivate
conda<span class="w"> </span>activate<span class="w"> </span><span class="si">${</span><span class="nv">CUPID_INFRASTRUCTURE_ENV</span><span class="si">}</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CUPID_GEN_DIAGNOSTICS</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;TRUE&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="si">${</span><span class="nv">CUPID_ROOT</span><span class="si">}</span>/cupid/run_diagnostics.py<span class="w"> </span><span class="si">${</span><span class="nv">CUPID_FLAG_STRING</span><span class="si">}</span>
<span class="k">fi</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CUPID_GEN_HTML</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;TRUE&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="si">${</span><span class="nv">CUPID_ROOT</span><span class="si">}</span>/cupid/generate_webpage.py
<span class="k">fi</span>
</pre></div>
</div>
<p>You can see how the variables defined in <code class="docutils literal notranslate"><span class="pre">env_postprocessing.xml</span></code> impact what parts of CUPiD are run.
In the next task we will make sure these XML variables are set correctly and then ask CESM to run <code class="docutils literal notranslate"><span class="pre">case.cupid</span></code>.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/diagnostics"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="CUPiD_projects.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Advanced CUPiD Tutorial</p>
      </div>
    </a>
    <a class="right-next"
       href="contributing_to_CUPiD.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Contributing to CUPiD</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#task-3">Task 3:</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#task-3-1-moving-to-derecho-and-navigating-to-your-cesm-case">Task 3.1: Moving to Derecho and Navigating to your CESM case</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#moving-to-derecho">Moving to Derecho</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#navigating-to-cesm-case">Navigating to CESM Case</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#task-3-2-explore-how-cupid-is-incorporated-in-a-cesm-case">Task 3.2: Explore how CUPiD is Incorporated in a CESM Case</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#task-3-3-configure-and-run-cupid">Task 3.3: Configure and Run CUPiD</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#side-quest-how-does-cupid-tie-in-to-cesm">Side Quest: How Does CUPiD Tie in to CESM?</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By CROCODILE-CESM
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>